import fs from 'fs';
import path from 'path';

const PORTFOLIO_DIR = path.join(process.cwd(), 'public', 'portfolio');
const OUTPUT_FILE = path.join(process.cwd(), 'src', 'data', 'projects.ts');

function scan() {
    if (!fs.existsSync(PORTFOLIO_DIR)) {
        console.log("Portfolio directory does not exist.");
        return;
    }

    const categories = fs.readdirSync(PORTFOLIO_DIR).filter(f =>
        fs.statSync(path.join(PORTFOLIO_DIR, f)).isDirectory()
    );

    const projects = [];
    let idCounter = 1;

    categories.forEach(category => {
        const categoryPath = path.join(PORTFOLIO_DIR, category);

        if (category === 'Websites') {
            const niches = fs.readdirSync(categoryPath).filter(f =>
                fs.statSync(path.join(categoryPath, f)).isDirectory()
            );

            niches.forEach(niche => {
                const nichePath = path.join(categoryPath, niche);
                const projectFiles = fs.readdirSync(nichePath).filter(f => f.endsWith('.txt'));

                projectFiles.forEach(file => {
                    const filePath = path.join(nichePath, file);
                    const url = fs.readFileSync(filePath, 'utf-8').trim();
                    const title = file.replace('.txt', '').replace(/-/g, ' ');

                    if (url) {
                        projects.push({
                            id: idCounter++,
                            title,
                            category,
                            niche: niche.replace(/-/g, ' '),
                            type: 'website',
                            desc: `A high-performance ${niche.replace(/-/g, ' ')} website.`,
                            details: `Direct live preview of ${title} project.`,
                            externalLink: url,
                            media: [
                                {
                                    type: 'image',
                                    url: `https://screenshot.microlink.io/${encodeURIComponent(url)}`
                                }
                            ]
                        });
                    }
                });
            });
        } else {
            const folderProjects = fs.readdirSync(categoryPath).filter(f =>
                fs.statSync(path.join(categoryPath, f)).isDirectory()
            );

            folderProjects.forEach(projectFolder => {
                const projectPath = path.join(categoryPath, projectFolder);
                const files = fs.readdirSync(projectPath).sort();

                let title = projectFolder.replace(/-/g, ' ');
                let description = "";
                let details = "";

                const infoFile = path.join(projectPath, 'info.txt');
                if (fs.existsSync(infoFile)) {
                    const content = fs.readFileSync(infoFile, 'utf-8');
                    const parts = content.split('---');

                    const metaLines = parts[0].split('\n');
                    metaLines.forEach(line => {
                        if (line.startsWith('Title:')) title = line.replace('Title:', '').trim();
                        if (line.startsWith('Description:')) description = line.replace('Description:', '').trim();
                    });

                    if (parts[1]) details = parts[1].replace('Details:', '').trim();
                }

                const media = files
                    .filter(f => f.match(/\.(jpg|jpeg|png|webp|mp4|webm)$/i))
                    .map(f => ({
                        type: f.endsWith('.mp4') || f.endsWith('.webm') ? 'video' : 'image',
                        url: `/portfolio/${category}/${projectFolder}/${f}`
                    }));

                if (media.length > 0) {
                    projects.push({
                        id: idCounter++,
                        title,
                        category,
                        type: media[0].type,
                        desc: description || `Original ${category} project.`,
                        details: details || description,
                        media
                    });
                }
            });
        }
    });

    const fileContent = `// Automatically generated by scan-portfolio utility
export interface MediaItem {
    type: 'video' | 'image';
    url: string;
}

export interface Project {
    id: number;
    title: string;
    category: string;
    type: string;
    desc: string;
    details: string;
    niche?: string;
    externalLink?: string;
    media: MediaItem[];
}

export const projects: Project[] = ${JSON.stringify(projects, null, 4)};
`;

    fs.mkdirSync(path.dirname(OUTPUT_FILE), { recursive: true });
    fs.writeFileSync(OUTPUT_FILE, fileContent);
    console.log(`Generated portfolio data with ${projects.length} projects.`);
}

scan();
